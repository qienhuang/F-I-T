# EST Pre-Registration: MTA Subway Hourly Ridership
# Case ID: mta_subway_hourly_tier2p11
# Version: 0.1 (hourly)
# Date: 2026-01-31
# Focus: P11-style diagnostics under windowed coherence (EST gate).

meta:
  case_id: mta_subway_hourly_tier2p11
  version: "0.1_hourly"
  date: "2026-01-31"
  tier: 2
  proposition: P11
  status: active

boundary:
  dataset_type: ["mta_subway_hourly"]
  time_range:
    start: "2019-01-01"
    end: "2024-12-31"
  aggregation:
    bucket: "H"
    timezone: "America/New_York"
  raw_glob: "data/raw/*.csv"

state:
  variables:
    - ridership_total
    - station_ridership_counts
    - station_active_count

estimators:
  information:
    I_entropy_station:
      type: shannon_entropy
      source: station_ridership_counts
      description: "Station ridership diversity (Shannon entropy)"
      enabled: true

  constraint:
    C_load:
      type: log1p
      source: ridership_total
      description: "System load proxy (log1p total ridership)"
      enabled: true

    C_concentration:
      type: topk_share
      source: station_ridership_counts
      k: 10
      description: "Top-10 station share (spatial concentration proxy)"
      enabled: true

  force:
    F_load_drift:
      type: rolling_diff
      source: ridership_total
      window: 168  # 7 days in hours
      description: "Weekly drift in ridership (diagnostic only)"
      enabled: true

window:
  smoothing: 1
  derivative: 1
  min_periods: 30

coherence:
  metric: spearman
  threshold: 0.6
  min_points: 200
  pairs:
    - [C_load, C_concentration]
  windowing:
    type: date_ranges
    aggregate: all_pass
    allow_pooled_fail: true
    ranges:
      - id: pre_covid
        start: "2019-01-01"
        end: "2020-02-29"
      - id: post_covid
        start: "2020-03-01"
        end: "2024-12-31"

regime_detection:
  method: robust_zscore_peak
  parameters:
    zscore_threshold: 2.5
    min_peak_distance: 24
    rolling_window: 336
    window_size: 168
    shift_threshold: null
  alternative_methods:
    - rolling_mean_shift

outputs:
  metrics_log: "outputs/metrics_log.parquet"
  regime_report: "outputs/regime_report.md"
  tradeoff_figure: "outputs/tradeoff_onepage.pdf"
  coherence_report: "outputs/coherence_report.json"
  change_points: "outputs/change_points.json"
  fail_windows: "outputs/fail_windows.md"

failure_labels:
  ESTIMATOR_UNSTABLE: "Coherence gate failed; regime interpretation forbidden at this scope"
  OK_PER_WINDOW: "Pooled FAIL but all preregistered windows PASS; interpret within-window only"
  STRUCTURE_MISMATCH: "Pooled PASS but at least one preregistered window FAIL; treat as estimator mismatch at this scope"
  DATA_MISSING: "Insufficient data for reliable estimation"
  SCHEMA_DRIFT: "Data schema changed; requires new preregistration"
