# EST Pre-Registration: MTA Subway Ridership (Daily 2023-2024)
# Case ID: mta_subway_hourly_tier2p11
# Version: 0.3 (daily, 2023-2024 continuous)
# Date: 2026-01-31
# Focus: Post-pandemic stable period with full daily coverage

meta:
  case_id: mta_subway_hourly_tier2p11
  version: "0.3_daily_2023_2024"
  date: "2026-01-31"
  tier: 2
  proposition: P11
  status: active
  prior_versions:
    - version: "0.2_daily"
      key_finding: "Sampled data had gaps; insufficient for coherence"

boundary:
  dataset_type: ["mta_subway_hourly"]
  time_range:
    start: "2023-01-01"
    end: "2024-07-08"
  aggregation:
    bucket: "D"
    timezone: "America/New_York"
  raw_glob: "data/raw/*.csv"

state:
  variables:
    - ridership_total
    - station_ridership_counts
    - station_active_count

estimators:
  information:
    I_entropy_station:
      type: shannon_entropy
      source: station_ridership_counts
      description: "Station ridership diversity (Shannon entropy)"
      enabled: true

  constraint:
    C_load:
      type: log1p
      source: ridership_total
      description: "System load proxy (log1p total ridership)"
      enabled: true

    C_concentration:
      type: topk_share
      source: station_ridership_counts
      k: 10
      description: "Top-10 station share (spatial concentration proxy)"
      enabled: true

  force:
    F_load_drift:
      type: rolling_diff
      source: ridership_total
      window: 7
      description: "Weekly drift in ridership (diagnostic only)"
      enabled: true

window:
  smoothing: 7
  derivative: 1
  min_periods: 30

coherence:
  metric: spearman
  threshold: 0.6
  min_points: 30
  pairs:
    - [C_load, C_concentration]
  windowing:
    type: date_ranges
    aggregate: all_pass
    allow_pooled_fail: true
    ranges:
      - id: H1_2023
        start: "2023-01-01"
        end: "2023-12-31"
      - id: H2_2024
        start: "2024-01-01"
        end: "2024-07-08"

regime_detection:
  method: robust_zscore_peak
  parameters:
    zscore_threshold: 2.5
    min_peak_distance: 7
    rolling_window: 21
    window_size: 14
    shift_threshold: null
  alternative_methods:
    - rolling_mean_shift

outputs:
  metrics_log: "outputs/metrics_log.parquet"
  regime_report: "outputs/regime_report.md"
  tradeoff_figure: "outputs/tradeoff_onepage.pdf"
  coherence_report: "outputs/coherence_report.json"
  change_points: "outputs/change_points.json"
  fail_windows: "outputs/fail_windows.md"

failure_labels:
  ESTIMATOR_UNSTABLE: "Coherence gate failed; regime interpretation forbidden at this scope"
  OK_PER_WINDOW: "Pooled FAIL but all preregistered windows PASS; interpret within-window only"
  OK_TO_INTERPRET: "Coherence gate passed at all scopes"
  STRUCTURE_MISMATCH: "Pooled PASS but at least one preregistered window FAIL"
  DATA_MISSING: "Insufficient data for reliable estimation"

# v2.5 demo fields (do not affect this run's logic)
est_v2_5_demo:
  expected_sign: +1
  coherence_radius_spec:
    note: "Demo-only. For this case, 'radius' is intended to be evaluated over preregistered variants (hourly vs daily, or multiple date windows), not computed by this run."
    candidate_axes:
      - axis: "aggregation.bucket"
        values: ["H", "D"]
      - axis: "window_grid_days"
        values: [30, 60, 90, 180, 365]
  boundary_warmup_spec:
    applies_to_this_run: false
    warmup_exclusion: "first 30d"
    edge_exclusion: "last 30d"
    undefined_metric_policy: "SCOPE_LIMITED"
